<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filippo's Diagnostic Algorithm v3.6.6 - Spitz vs Melanoma</title>
    <meta name="description" content="Algoritmo diagnostico con DD nevi comuni - Solo lesioni SPITZOIDI">
    <meta name="author" content="Dr. Filippo Bianchi - SC Anatomia Patologica Fatebenefratelli Milano">
    <meta name="keywords" content="spitz nevus, melanoma, dermatopathology, differential diagnosis, bastian 2014, MAP3K8">
    
    <!-- html2pdf.js for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --bg-main: #f8f9fa;
            --bg-card: #ffffff;
            --text-main: #2c3e50;
            --text-muted: #6c757d;
            --accent: #3498db;
            --accent-soft: #e8f4f8;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --border: #dee2e6;
            --border-subtle: #e9ecef;
            --chip-bg: #f8f9fa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-main);
            color: var(--text-main);
            line-height: 1.6;
            padding: 1rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: var(--bg-card);
            padding: 2rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--accent);
        }

        .header .subtitle {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .disclaimer {
            background: #fff3cd;
            border-left: 4px solid var(--warning);
            padding: 1rem;
            margin-bottom: 2rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 0.8rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-main);
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-subtle);
        }

        .form-group {
            margin-bottom: 1.3rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.4rem;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-main);
            position: relative;
        }

        .tooltip-trigger {
            display: inline-block;
            margin-left: 0.3rem;
            width: 16px;
            height: 16px;
            background: var(--accent-soft);
            color: var(--accent);
            border-radius: 50%;
            text-align: center;
            line-height: 16px;
            font-size: 0.7rem;
            cursor: help;
            position: relative;
        }

        .tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            z-index: 100;
            background: var(--text-main);
            color: white;
            padding: 0.8rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            line-height: 1.4;
            width: 300px;
            top: 100%;
            left: 0;
            margin-top: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: opacity 0.2s, visibility 0.2s;
        }

        .tooltip a {
            color: #81d4fa;
            text-decoration: underline;
            margin-left: 0.3rem;
        }

        .tooltip-trigger:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        select, input {
            width: 100%;
            padding: 0.7rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.9rem;
            background: var(--bg-card);
            color: var(--text-main);
            transition: border-color 0.2s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            padding: 0.9rem 2rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: var(--chip-bg);
            color: var(--text-main);
            padding: 0.7rem 1.5rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        #result {
            display: none;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-subtle);
        }

        .tab {
            padding: 0.8rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            margin-bottom: -2px;
        }

        .tab:hover {
            color: var(--accent);
        }

        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .score-display {
            text-align: center;
            padding: 2rem;
            background: linear-gradient(135deg, var(--accent-soft) 0%, #ffffff 100%);
            border-radius: 0.8rem;
            margin-bottom: 1.5rem;
        }

        .score-value {
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }

        .score-label {
            font-size: 1rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .interpretation {
            padding: 1.2rem;
            border-radius: 0.7rem;
            margin: 1rem 0;
            border-left: 4px solid;
        }

        .interpretation.success {
            background: #d4edda;
            border-color: var(--success);
            color: #155724;
        }

        .interpretation.warning {
            background: #fff3cd;
            border-color: var(--warning);
            color: #856404;
        }

        .interpretation.danger {
            background: #f8d7da;
            border-color: var(--danger);
            color: #721c24;
        }

        .interpretation.info {
            background: var(--accent-soft);
            border-color: var(--accent);
            color: #004085;
        }

        .chip {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 500;
            margin: 0.2rem;
        }

        .chip-ok {
            background: #d4edda;
            color: var(--success);
        }

        .chip-warn {
            background: #fff3cd;
            color: var(--warning);
        }

        .chip-danger {
            background: #f8d7da;
            color: var(--danger);
        }

        .chip-info {
            background: var(--accent-soft);
            color: var(--accent);
        }

        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        .breakdown-table th, .breakdown-table td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid var(--border-subtle);
        }

        .breakdown-table th {
            background: var(--chip-bg);
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .breakdown-table td {
            font-size: 0.9rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 0.7rem;
            margin: 1rem 0;
            border-left: 4px solid;
        }

        .alert-success {
            background: #d4edda;
            border-color: var(--success);
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: var(--warning);
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: var(--danger);
            color: #721c24;
        }

        .alert-info {
            background: var(--accent-soft);
            border-color: var(--accent);
            color: #004085;
        }

        .footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-size: 0.85rem;
            border-top: 1px solid var(--border);
            margin-top: 3rem;
        }

        .footer a {
            color: var(--accent);
            text-decoration: none;
        }

        /* Bibliografia Styles */
        .bib-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .bib-filter {
            padding: 0.4rem 0.9rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--chip-bg);
            color: var(--text-main);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .bib-filter:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .bib-filter.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        .bib-search {
            margin-bottom: 1.5rem;
        }
        
        .bib-search input {
            width: 100%;
            padding: 0.7rem 1rem;
            border-radius: 0.6rem;
            border: 1px solid var(--border);
            font-size: 0.9rem;
        }
        
        .bib-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.7rem;
            margin-bottom: 1rem;
            overflow: hidden;
            transition: all 0.2s;
        }
        
        .bib-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .bib-header {
            padding: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .bib-citation {
            flex: 1;
            font-size: 0.85rem;
            line-height: 1.5;
        }
        
        .bib-citation strong {
            color: var(--text-main);
        }
        
        .bib-citation em {
            color: var(--text-muted);
        }
        
        .expand-icon {
            color: var(--text-muted);
            font-size: 0.8rem;
            transition: transform 0.2s;
        }
        
        .bib-card.expanded .expand-icon {
            transform: rotate(180deg);
        }
        
        .bib-content {
            padding: 0 1rem 1rem;
            display: none;
            border-top: 1px solid var(--border-subtle);
            padding-top: 1rem;
        }
        
        .bib-card.expanded .bib-content {
            display: block;
        }
        
        .bib-findings {
            margin: 1rem 0;
            padding: 0.8rem;
            background: var(--accent-soft);
            border-radius: 0.5rem;
            font-size: 0.8rem;
            line-height: 1.6;
        }
        
        .bib-chips {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin: 0.8rem 0;
        }
        
        .bib-links {
            display: flex;
            gap: 0.8rem;
            margin-top: 1rem;
        }
        
        .bib-links a {
            padding: 0.4rem 0.8rem;
            border-radius: 0.5rem;
            background: var(--chip-bg);
            color: var(--accent);
            text-decoration: none;
            font-size: 0.75rem;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }
        
        .bib-links a:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        .bib-export {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab {
                white-space: nowrap;
            }
            
            .tooltip {
                width: 250px;
                left: auto;
                right: 0;
            }
        }

        @media print {
            body {
                background: white;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid var(--border);
            }
            
            .btn-primary, .btn-secondary {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî¨ Spitz vs Melanoma Diagnostic Algorithm v3.6.6</h1>
            <div class="subtitle">
                Algoritmo per lesioni SPITZOIDI con DD nevi comuni - Malignancy Score 0-100
            </div>
        </div>

        <div class="disclaimer" role="note">
            <strong>‚ö†Ô∏è v3.6.6:</strong> Caveat medico-legali, SNB limitazioni, warning overconfidence.<br>
            <strong>DISCLAIMER:</strong> Il tool √® un ausilio decisionale, non sostituisce l'esperienza del patologo.
        </div>

        <div class="alert alert-warning" style="margin-bottom: 2rem;">
            <strong>‚ö†Ô∏è PREREQUISITO MORFOLOGICO - LEGGERE PRIMA DELL'USO:</strong><br><br>
            
            Questo algoritmo √® applicabile <strong>ESCLUSIVAMENTE</strong> a lesioni melanocitiche con <strong>morfologia SPITZOIDE confermata</strong>, caratterizzate da:
            <ul style="margin: 0.5rem 0 0.5rem 1.5rem; line-height: 1.6;">
                <li>Cellule epitelioidi e/o fusate</li>
                <li>Nuclei vescicolosi prominenti con nucleoli evidenti</li>
                <li>Possibile presenza di cellule giganti multinucleate</li>
            </ul>
            
            <strong style="color: #721c24;">‚ùå NON UTILIZZARE per:</strong>
            <ul style="margin: 0.5rem 0 0 1.5rem; line-height: 1.6;">
                <li><strong>Nevi melanocitici comuni</strong> (giunzionali, composti, dermici banali)</li>
                <li><strong>Blue nevi</strong> o altre varianti melanocitiche non-spitzoidi</li>
                <li><strong>Melanomi convenzionali</strong> senza morfologia spitzoide</li>
            </ul>
            
            <strong style="color: #004085;">üìñ Vedi sezione "Diagnosi Differenziale" qui sotto per dettagli!</strong>
        </div>
        <div class="card" style="margin-bottom: 2rem; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
            <div class="section-title" style="cursor: pointer;" onclick="toggleDDSection()">
                üîç Diagnosi Differenziale: Lesioni Spitzoidi vs Nevi Comuni
                <span id="ddToggle" style="float: right; font-size: 1.2rem;">‚ñº</span>
            </div>
            
            <div id="ddContent" style="display: none; margin-top: 1rem;">
                <div style="background: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                    <strong style="color: #155724;">‚úÖ QUANDO USARE QUESTO TOOL (Morfologia Spitzoide):</strong>
                    <p style="margin: 0.5rem 0;">Lesioni con almeno 3-4 delle seguenti caratteristiche:</p>
                </div>

                <table class="breakdown-table" style="margin-bottom: 1.5rem;">
                    <thead>
                        <tr>
                            <th style="width: 25%;">Caratteristica</th>
                            <th style="width: 37.5%; background: #d4edda;">LESIONI SPITZOIDI<br><small>(USA QUESTO TOOL)</small></th>
                            <th style="width: 37.5%; background: #f8d7da;">NEVI COMUNI<br><small>(NON USARE TOOL)</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Citologia</strong></td>
                            <td style="background: #d4edda;">
                                <strong>Cellule epitelioidi e/o fusate</strong><br>
                                <small>Citoplasma abbondante eosinofilo o chiaro</small>
                            </td>
                            <td style="background: #f8d7da;">
                                <strong>Piccole cellule rotonde/ovali</strong><br>
                                <small>Citoplasma scarso, melanociti convenzionali</small>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Nuclei</strong></td>
                            <td style="background: #d4edda;">
                                <strong>Vescicolosi, prominenti</strong><br>
                                <small>Nucleoli evidenti, "a vetro smerigliato"</small>
                            </td>
                            <td style="background: #f8d7da;">
                                <strong>Piccoli, regolari, condensati</strong><br>
                                <small>Nucleoli inconspicui o assenti</small>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Cellule giganti</strong></td>
                            <td style="background: #d4edda;">
                                <strong>Spesso presenti</strong><br>
                                <small>Multinucleate (2-20+ nuclei), tipiche Spitz</small>
                            </td>
                            <td style="background: #f8d7da;">
                                <strong>Assenti</strong><br>
                                <small>Non caratteristica dei nevi comuni</small>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Architettura</strong></td>
                            <td style="background: #d4edda;">
                                <strong>Simmetrica O asimmetrica</strong><br>
                                <small>Variabile - da Spitz benigno a melanoma</small>
                            </td>
                            <td style="background: #f8d7da;">
                                <strong>Tipicamente simmetrica</strong><br>
                                <small>Ben circoscritta, regolare</small>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Maturazione</strong></td>
                            <td style="background: #d4edda;">
                                <strong>Variabile</strong><br>
                                <small>Presente negli Spitz benigni, assente/invertita nei maligni</small>
                            </td>
                            <td style="background: #f8d7da;">
                                <strong>Sempre presente</strong><br>
                                <small>Regolare A‚ÜíB‚ÜíC dalla superficie al profondo</small>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Nidi</strong></td>
                            <td style="background: #d4edda;">
                                <strong>Grandi, espansivi</strong><br>
                                <small>Cellule grandi ‚Üí nidi voluminosi</small>
                            </td>
                            <td style="background: #f8d7da;">
                                <strong>Piccoli, regolari</strong><br>
                                <small>Dimensioni uniformi, ben distanziati</small>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Et√† tipica</strong></td>
                            <td style="background: #d4edda;">
                                <strong>Bambini/giovani adulti</strong><br>
                                <small>Picco &lt;20 anni, ma possibile a tutte le et√†</small>
                            </td>
                            <td style="background: #f8d7da;">
                                <strong>Tutte le et√†</strong><br>
                                <small>Acquisiti durante la vita</small>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Clinica</strong></td>
                            <td style="background: #d4edda;">
                                <strong>Papula eritematosa/rosa</strong><br>
                                <small>Spesso non pigmentata, a crescita rapida</small>
                            </td>
                            <td style="background: #f8d7da;">
                                <strong>Macula/papula pigmentata</strong><br>
                                <small>Marrone uniforme, stabile nel tempo</small>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 1rem; margin-bottom: 1rem; border-radius: 0.5rem;">
                    <strong>‚ö†Ô∏è GRAY ZONE - Lesioni borderline:</strong><br>
                    Nevi comuni con <strong>atipia focale</strong> o nevi di Spitz "convenzionali" senza atipia significativa possono creare dubbi diagnostici.
                    <ul style="margin: 0.5rem 0 0 1.5rem;">
                        <li><strong>Nevo comune con atipia focale:</strong> Valutare se atipia √® reattiva (trauma, sun damage) vs intrinseca</li>
                        <li><strong>Spitz nevus "tipico" senza atipia:</strong> Score atteso 0-20/100, diagnosi clinica/morfologica sufficiente</li>
                        <li><strong>In caso di dubbio:</strong> Second opinion esperta, eventuale genomica (FISH, NGS)</li>
                    </ul>
                </div>

                <div style="background: #d1ecf1; border-left: 4px solid #17a2b8; padding: 1rem; border-radius: 0.5rem;">
                    <strong>üí° RULE OF THUMB per decidere se usare il tool:</strong><br>
                    <strong style="color: #155724;">"Se guardi al microscopio e pensi 'questo ha cellule grandi/strane/diverse', allora √® probabilmente spitzoide"</strong><br>
                    <strong style="color: #721c24;">"Se pensi 'nevo banale', allora NON √® il caso per questo tool"</strong><br>
                    <br>
                    <small><em>In caso di dubbio morfologico, consultare atlanti (Massi & LeBoit 2014) o richiedere second opinion prima di applicare il tool.</em></small>
                </div>
            </div>
        </div>

        <script>
        function toggleDDSection() {
            const content = document.getElementById('ddContent');
            const toggle = document.getElementById('ddToggle');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                toggle.textContent = '‚ñº';
            }
        }
        </script>
        
        <div class="card">
            <div class="section-title">üìä Criteri Morfologici - Punti Malignit√† (Massi & LeBoit 2014)</div>
            <div class="form-group">
                <label>
                    Maturazione A‚ÜíB‚ÜíC
                    <span class="tooltip-trigger">‚ìò
                        <span class="tooltip">
                            <strong>Criterio critico</strong> (0-20 punti malignit√†). Maturazione presente = 0 punti (benigno). Assente/invertita ‚â•16 punti = RED FLAG melanoma.
                            <a href="#" onclick="event.preventDefault(); showBibCard('massi2014')">üìö Massi 2014</a>
                        </span>
                    </span>
                </label>
                <select id="maturation">
                    <option value="0">Presente e completa (0 punti - BENIGNO)</option>
                    <option value="5">Presente ma parziale (5 punti)</option>
                    <option value="11">Dubbia/minima (11 punti)</option>
                    <option value="16">Assente o invertita (16 punti - RED FLAG)</option>
                    <option value="20">Completamente assente (20 punti - RED FLAG)</option>
                </select>
            </div>

            <div class="form-group">
                <label>
                    Simmetria
                    <span class="tooltip-trigger">‚ìò
                        <span class="tooltip">
                            <strong>Criterio importante</strong> (0-15 punti malignit√†). Simmetrica = 0 punti (benigno). Asimmetrica = 15 punti (maligno).
                            <a href="#" onclick="event.preventDefault(); showBibCard('massi2014')">üìö Massi 2014</a>
                        </span>
                    </span>
                </label>
                <select id="symmetry">
                    <option value="0">Perfettamente simmetrica (0 punti - BENIGNO)</option>
                    <option value="3">Prevalentemente simmetrica (3 punti)</option>
                    <option value="8">Parzialmente asimmetrica (8 punti)</option>
                    <option value="12">Francamente asimmetrica (12 punti)</option>
                    <option value="15">Completamente asimmetrica (15 punti - MALIGNO)</option>
                </select>
            </div>

            <div class="form-group">
                <label>
                    Circoscrizione
                    <span class="tooltip-trigger">‚ìò
                        <span class="tooltip">
                            <strong>Criterio importante</strong> (0-15 punti malignit√†). Ben circoscritta = 0 punti (benigno). Infiltrativa = 15 punti (maligno).
                            <a href="#" onclick="event.preventDefault(); showBibCard('massi2014')">üìö Massi 2014</a>
                        </span>
                    </span>
                </label>
                <select id="circumscription">
                    <option value="0">Ben circoscritta (0 punti - BENIGNO)</option>
                    <option value="3">Prevalentemente circoscritta (3 punti)</option>
                    <option value="8">Parzialmente infiltrativa (8 punti)</option>
                    <option value="12">Infiltrazione moderata (12 punti)</option>
                    <option value="15">Infiltrazione diffusa (15 punti - MALIGNO)</option>
                </select>
            </div>

            <div class="form-group">
                <label>
                    Cellule giganti multinucleate
                    <span class="tooltip-trigger">‚ìò
                        <span class="tooltip">
                            <strong>Feature spitzoide caratteristica</strong> (0-8 punti malignit√†). Presenti e tipiche = 0 punti (benigno Spitz). Assenti = 8 punti (non discriminante da solo - verificare altri criteri).
                            <a href="#" onclick="event.preventDefault(); showBibCard('massi2014')">üìö Massi 2014</a>
                        </span>
                    </span>
                </label>
                <select id="giant_cells">
                    <option value="0">Presenti e tipiche (0 punti - BENIGNO)</option>
                    <option value="2">Presenti focalmente (2 punti)</option>
                    <option value="5">Rare (5 punti)</option>
                    <option value="8">Assenti (8 punti - non discriminante da solo)</option>
                </select>
            </div>

            <div class="form-group">
                <label>
                    Mitosi derma profondo
                    <span class="tooltip-trigger">‚ìò
                        <span class="tooltip">
                            <strong>Criterio critico</strong> (0-15 punti malignit√†). Assenti = 0 punti (benigno). ‚â•6/mm¬≤ e/o atipiche ‚â•12 punti = RED FLAG melanoma.
                            <a href="#" onclick="event.preventDefault(); showBibCard('massi2014')">üìö Massi 2014</a>
                        </span>
                    </span>
                </label>
                <select id="mitoses">
                    <option value="0">Assenti nel derma profondo (0 punti - BENIGNO)</option>
                    <option value="3">1-2/mm¬≤ derma profondo (3 punti)</option>
                    <option value="8">3-5/mm¬≤ derma profondo (8 punti)</option>
                    <option value="12">‚â•6/mm¬≤ derma profondo (12 punti - RED FLAG)</option>
                    <option value="15">Multiple e/o atipiche (15 punti - RED FLAG)</option>
                </select>
            </div>

            <div class="form-group">
                <label>
                    Pattern di infiltrazione
                    <span class="tooltip-trigger">‚ìò
                        <span class="tooltip">
                            <strong>Pattern tissutale</strong> (0-10 punti malignit√†). Nidi coesi = 0 punti (Spitz). Singles cells = 10 punti (melanoma).
                            <a href="#" onclick="event.preventDefault(); showBibCard('massi2014')">üìö Massi 2014</a>
                        </span>
                    </span>
                </label>
                <select id="infiltration">
                    <option value="0">Nidi coesi organizzati (0 punti - BENIGNO)</option>
                    <option value="3">Nidi con qualche singola cellula (3 punti)</option>
                    <option value="7">Misto nidi e singles (7 punti)</option>
                    <option value="10">Prevalentemente singles cells (10 punti - MALIGNO)</option>
                </select>
            </div>

            <div class="form-group">
                <label>
                    Necrosi
                    <span class="tooltip-trigger">‚ìò
                        <span class="tooltip">
                            <strong>Feature maligna</strong> (0-5 punti malignit√†). Assente = 0 punti (OK). Necrosi "en masse" = 5 punti (RED FLAG melanoma).
                            <a href="#" onclick="event.preventDefault(); showBibCard('massi2014')">üìö Massi 2014</a>
                        </span>
                    </span>
                </label>
                <select id="necrosis">
                    <option value="0">Assente (0 punti - BENIGNO)</option>
                    <option value="1">Necrosi cheratinocitaria focale (1 punto)</option>
                    <option value="3">Necrosi piccoli foci (3 punti)</option>
                    <option value="5">Necrosi "en masse" (5 punti - RED FLAG)</option>
                </select>
            </div>

            <div class="form-group">
                <label>
                    Atipia nucleare
                    <span class="tooltip-trigger">‚ìò
                        <span class="tooltip">
                            <strong>Atipia citologica</strong> (0-10 punti malignit√†). Minima = 0 punti (Spitz OK). Estrema = 10 punti (melanoma).
                            <a href="#" onclick="event.preventDefault(); showBibCard('massi2014')">üìö Massi 2014</a>
                        </span>
                    </span>
                </label>
                <select id="atypia">
                    <option value="0">Minima/assente (0 punti - BENIGNO)</option>
                    <option value="2">Lieve (nuclei grandi ma regolari) (2 punti)</option>
                    <option value="5">Moderata con variabilit√† (5 punti)</option>
                    <option value="8">Severa (8 punti)</option>
                    <option value="10">Estrema con pleomorfismo (10 punti - MALIGNO)</option>
                </select>
            </div>

            <div class="form-group">
                <label>
                    Ulcerazione
                    <span class="tooltip-trigger">‚ìò
                        <span class="tooltip">
                            <strong>Feature aggiuntiva</strong> (0-5 punti malignit√†). Assente = 0 punti. Estesa = 5 punti (concern melanoma). Houlier 2020: ulcerazione in 32% MAP3K8-fused.
                            <a href="#" onclick="event.preventDefault(); showBibCard('houlier2020')">üìö Houlier 2020</a>
                        </span>
                    </span>
                </label>
                <select id="ulceration">
                    <option value="0">Assente (0 punti - BENIGNO)</option>
                    <option value="2">Focale (possibile trauma) (2 punti)</option>
                    <option value="4">Estesa (4 punti - CONCERN)</option>
                    <option value="5">Estesa + necrosi (5 punti)</option>
                </select>
            </div>

            <button class="btn-primary" onclick="calculateScore()">üßÆ Calcola Malignancy Score</button>
        </div>
        
        <div class="card">
            <div class="section-title">üß¨ Stratificazione Genetica (Bastian 2014)</div>
            
            <div class="form-group">
                <label>
                    Driver Mutation
                    <span class="tooltip-trigger">‚ìò
                        <span class="tooltip">
                            <strong>Profilo genetico principale.</strong> Alterazioni oncogeniche che definiscono comportamento biologico. TERT = criterio solido malignit√† (richiede correlazione clinica).
                            <a href="#" onclick="event.preventDefault(); showBibCard('bastian2014')">üìö Bastian 2014</a>
                        </span>
                    </span>
                </label>
                <select id="bastian_driver">
                    <option value="">Non disponibile/Non testato</option>
                    <option value="hras">HRAS mutation (low-risk)</option>
                    <option value="kinase_fusion">Kinase fusion (ALK/ROS1/RET/NTRK1/BRAF)</option>
                    <option value="map3k8">MAP3K8 fusion/truncation</option>
                    <option value="braf_bap1">BRAF V600E + BAP1 loss</option>
                    <option value="tert">‚ö†Ô∏è TERT promoter mutation (criterio solido)</option>
                    <option value="gnaq_gna11">GNAQ/GNA11 Q209 (non-Spitz)</option>
                    <option value="cdkn2a_only">CDKN2A loss isolato</option>
                </select>
            </div>

            <div class="form-group">
                <label>
                    CNA Profile
                    <span class="tooltip-trigger">‚ìò
                        <span class="tooltip">
                            <strong>Copy Number Aberrations.</strong> Single gain 11p = HRAS low-risk. Multiple CNAs = instabilit√† genomica red flag. Chr 6 loss = marker malignit√†.
                            <a href="#" onclick="event.preventDefault(); showBibCard('bastian2014')">üìö Bastian 2014</a>
                        </span>
                    </span>
                </label>
                <select id="bastian_cna">
                    <option value="">Non disponibile/Non testato</option>
                    <option value="none">No significant CNAs</option>
                    <option value="single_gain">Single copy gain (e.g. 11p)</option>
                    <option value="multiple_cna">‚ö†Ô∏è Multiple CNAs (red flag)</option>
                    <option value="chr_6_loss">‚ö†Ô∏è Chromosome 6 loss</option>
                </select>
            </div>
        </div>

        <div id="result" class="card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab(event, 'morph')">Morfologia</button>
                <button class="tab" onclick="switchTab(event, 'bastian')">Genetica</button>
                <button class="tab" onclick="switchTab(event, 'summary')">Sommario</button>
                <button class="tab" onclick="switchTab(event, 'bibliography')">Bibliografia</button>
            </div>

            <div id="morph" class="tab-content active">
                <div class="score-display">
                    <div class="score-value" id="totalScore">--</div>
                    <div class="score-label">Score Morfologico Normalizzato (0-100)</div>
                </div>
                
                <div id="morphInterpretation"></div>
                <div id="scoreBreakdown"></div>
            </div>

            <div id="bastian" class="tab-content">
                <div id="bastianAnalysis"></div>
            </div>

            <div id="summary" class="tab-content">
                <div id="summaryContent"></div>
            </div>

            <div id="bibliography" class="tab-content">
                <div class="section-title" style="margin-top: 0;">üìö Bibliografia Scientifica</div>
                
                <div class="bib-search">
                    <input type="text" 
                           id="bibSearch" 
                           placeholder="üîç Cerca autore, anno, keywords..."
                           onkeyup="filterBibliography()">
                </div>
                
                <div class="bib-filters">
                    <button class="bib-filter active" data-filter="all" onclick="filterBibByCategory('all')">Tutte</button>
                    <button class="bib-filter" data-filter="morfologia" onclick="filterBibByCategory('morfologia')">Morfologia</button>
                    <button class="bib-filter" data-filter="genetica" onclick="filterBibByCategory('genetica')">Genetica</button>
                    <button class="bib-filter" data-filter="review" onclick="filterBibByCategory('review')">Review</button>
                </div>
                
                <div id="bibliographyCards"></div>
                
                <div class="bib-export">
                    <button class="btn-secondary" onclick="exportBibTeX()">
                        üìÑ Esporta BibTeX
                    </button>
                </div>
            </div>

            <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                <button class="btn-secondary" onclick="exportPDF()">üìÑ Esporta PDF</button>
                <button class="btn-secondary" onclick="resetForm()">üîÑ Reset</button>
            </div>
        </div>

        <div class="footer">
            <strong>Dr. Filippo Bianchi</strong> - Direttore SC Anatomia Patologica<br>
            ASST Fatebenefratelli-Sacco, Milano<br>
            üìß <a href="mailto:filippo.bianchi@asst-fbf-sacco.it">filippo.bianchi@asst-fbf-sacco.it</a> | 
            üíª <a href="https://github.com/infingardo/spitz-melanoma-tool" target="_blank">GitHub Repository</a><br>
            <br>
            <em>v3.6.6 (2024-12-06) - Caveat medico-legali, SNB limitazioni, warning overconfidence</em>
        </div>
    </div>

    <script>
        // Bibliografia COMPLETA con Newman AJSP aggiunto
        const bibliography = [
            {
                id: 'bastian2014',
                authors: 'Bastian BC',
                year: 2014,
                title: 'The Molecular Pathology of Melanoma: An Integrated Taxonomy of Melanocytic Neoplasia',
                journal: 'Annual Review of Pathology: Mechanisms of Disease',
                volume: 9,
                pages: '239-271',
                doi: '10.1146/annurev-pathol-012513-104658',
                pmid: '24460189',
                url: 'https://www.annualreviews.org/doi/10.1146/annurev-pathol-012513-104658',
                category: 'genetica',
                supportedCriteria: ['bastian_driver', 'bastian_cna', 'spitz_general'],
                keyFindings: 'Framework tassonomico integrato dei melanomi. Classificazione genomica: HRAS-mutated Spitz (low-risk), fusioni kinasiche (ALK, ROS1, RET, NTRK1) in 60% Spitz. GNAQ/GNA11 in blue nevi e uveal melanoma. TERT promoter come criterio solido di progressione maligna (85% metastasi vs 0% nevi). CDKN2A loss: evento secondario presente anche in AST, non diagnostico da solo.',
                bibtex: `@article{Bastian2014,
  author = {Bastian, Boris C},
  title = {The Molecular Pathology of Melanoma: An Integrated Taxonomy of Melanocytic Neoplasia},
  journal = {Annual Review of Pathology: Mechanisms of Disease},
  volume = {9},
  pages = {239-271},
  year = {2014},
  doi = {10.1146/annurev-pathol-012513-104658},
  pmid = {24460189}
}`
            },
            {
                id: 'newman2019_natmed',
                authors: 'Newman S, Fan L, Pribnow A, et al.',
                year: 2019,
                title: 'Clinical genome sequencing uncovers potentially targetable truncations and fusions of MAP3K8 in spitzoid and other melanomas',
                journal: 'Nature Medicine',
                volume: 25,
                pages: '597-602',
                doi: '10.1038/s41591-019-0373-y',
                pmid: '30988516',
                url: 'https://doi.org/10.1038/s41591-019-0373-y',
                category: 'genetica',
                supportedCriteria: ['bastian_driver'],
                keyFindings: 'MAP3K8 fusions/truncations in 33% melanomi spitzoidi pediatrici. Risposta clinica a MEK inhibitor. Rappresenta il driver genetico pi√π comune in melanoma spitzoide pediatrico. Target potenzialmente terapeutico.',
                bibtex: `@article{Newman2019NatMed,
  author = {Newman, Scott and Fan, Ling and Pribnow, Angela and others},
  title = {Clinical genome sequencing uncovers potentially targetable truncations and fusions of MAP3K8 in spitzoid and other melanomas},
  journal = {Nature Medicine},
  volume = {25},
  pages = {597-602},
  year = {2019},
  doi = {10.1038/s41591-019-0373-y},
  pmid = {30988516}
}`
            },
            {
                id: 'newman2019_ajsp',
                authors: 'Newman S, Rosenbach M, Chu EY, et al.',
                year: 2019,
                title: 'Pediatric spitzoid melanoma with MAP3K8 fusion',
                journal: 'American Journal of Surgical Pathology',
                volume: 43,
                issue: 9,
                pages: '1631-1637',
                pmid: '31498175',
                url: 'https://pubmed.ncbi.nlm.nih.gov/31498175/',
                category: 'genetica',
                supportedCriteria: ['bastian_driver', 'map3k8'],
                keyFindings: 'Cohort pediatrico MAP3K8-fused. 82% p16 loss, 70% homozygous CDKN2A deletion. Conferma correlazione tra MAP3K8 fusion e inactivazione CDKN2A come marcatore di progressione.',
                bibtex: `@article{Newman2019AJSP,
  author = {Newman, Scott and Rosenbach, Misha and Chu, Emily Y and others},
  title = {Pediatric spitzoid melanoma with MAP3K8 fusion},
  journal = {American Journal of Surgical Pathology},
  volume = {43},
  number = {9},
  pages = {1631-1637},
  year = {2019},
  pmid = {31498175}
}`
            },
            {
                id: 'houlier2020',
                authors: 'Houlier A, Pissaloux D, Masse I, et al.',
                year: 2020,
                title: 'Melanocytic tumors with MAP3K8 fusions: report of 33 cases with morphological-genetic correlations',
                journal: 'Modern Pathology',
                volume: 33,
                pages: '846-857',
                doi: '10.1038/s41379-019-0384-8',
                pmid: '31719662',
                url: 'https://doi.org/10.1038/s41379-019-0384-8',
                category: 'genetica',
                supportedCriteria: ['bastian_driver'],
                keyFindings: 'Serie di 33 casi MAP3K8-fused. CDKN2A inactivation nel 77% di casi atipici/maligni. Ulcerazione presente nel 32%. Preferenza anatomica: arti inferiori (55%). Partner 3\' pi√π comune: SVIL (46%). MAP3K8 expression significativamente elevata vs altri kinase fusions.',
                bibtex: `@article{Houlier2020,
  author = {Houlier, Aurelie and Pissaloux, Daniel and Masse, Ingrid and others},
  title = {Melanocytic tumors with MAP3K8 fusions: report of 33 cases with morphological-genetic correlations},
  journal = {Modern Pathology},
  volume = {33},
  pages = {846-857},
  year = {2020},
  doi = {10.1038/s41379-019-0384-8},
  pmid = {31719662}
}`
            },
            {
                id: 'massi2014',
                authors: 'Massi G, LeBoit PE',
                year: 2014,
                title: 'Histological Diagnosis of Nevi and Melanoma',
                journal: 'Springer',
                edition: '2nd Edition',
                isbn: '978-3-642-37310-7',
                url: 'https://link.springer.com/book/10.1007/978-3-642-37311-4',
                category: 'morfologia',
                supportedCriteria: ['maturation', 'morphology', 'mitoses', 'infiltration', 'asymmetry'],
                keyFindings: 'Textbook completo sulla diagnosi istologica di nevi e melanoma. Approccio pratico con criteri morfologici sistematici. Gates 0-8 approach per diagnosi differenziale Spitz vs melanoma. Maturazione A‚ÜíB‚ÜíC come criterio dirimente. Fotografie ad alta qualit√† con clues diagnostici evidenziati.',
                bibtex: `@book{Massi2014,
  author = {Massi, Guido and LeBoit, Philip E},
  title = {Histological Diagnosis of Nevi and Melanoma},
  edition = {2},
  publisher = {Springer},
  address = {Berlin, Heidelberg},
  year = {2014},
  isbn = {978-3-642-37310-7}
}`
            },
            {
                id: 'raghavan2020',
                authors: 'Raghavan SS, Peternel S, Mully TW, et al.',
                year: 2020,
                title: 'Spitz melanoma is a distinct subset of spitzoid melanoma',
                journal: 'Modern Pathology',
                volume: 33,
                pages: '1122-1134',
                doi: '10.1038/s41379-019-0445-z',
                pmid: '31857696',
                url: 'https://doi.org/10.1038/s41379-019-0445-z',
                category: 'review',
                supportedCriteria: ['spitz_general'],
                keyFindings: 'Solo 36% di "spitzoid melanomas" ha alterazioni genetiche caratteristiche di Spitz melanoma (HRAS mutation o fusion di BRAF, ALK, NTRK1, MAP3K8). Spitz melanoma √® subset distinto con profilo genomico specifico, non tutte le lesioni morfologicamente spitzoidi sono Spitz melanoma vero.',
                bibtex: `@article{Raghavan2020,
  author = {Raghavan, Shyam S and Peternel, Sandra and Mully, Thaddeus W and others},
  title = {Spitz melanoma is a distinct subset of spitzoid melanoma},
  journal = {Modern Pathology},
  volume = {33},
  pages = {1122-1134},
  year = {2020},
  doi = {10.1038/s41379-019-0445-z},
  pmid = {31857696}
}`
            }
        ];

        // ========== MAIN CALCULATION (v3.6.5 - Giant cells max 8, totale 103) ==========
        function calculateScore() {
            const scores = {
                maturation: parseInt(document.getElementById('maturation').value),
                symmetry: parseInt(document.getElementById('symmetry').value),
                circumscription: parseInt(document.getElementById('circumscription').value),
                giant_cells: parseInt(document.getElementById('giant_cells').value),
                mitoses: parseInt(document.getElementById('mitoses').value),
                infiltration: parseInt(document.getElementById('infiltration').value),
                necrosis: parseInt(document.getElementById('necrosis').value),
                atypia: parseInt(document.getElementById('atypia').value),
                ulceration: parseInt(document.getElementById('ulceration').value)
            };

            // Raw malignancy (0-103 con giant cells max 8) 
            const rawMalignancy = Object.values(scores).reduce((a, b) => a + b, 0);
            
            // Max totale: 20+15+15+8+15+10+5+10+5 = 103
            const maxRaw = 103;
            
            // Normalized malignancy score (0-100)
            const malignancyScore = Math.round((rawMalignancy / maxRaw) * 100);
            
            // Display malignancy score
            document.getElementById('totalScore').textContent = malignancyScore;
            document.getElementById('result').style.display = 'block';
            
            // Generate interpretations
            generateMorphInterpretation(malignancyScore, scores, rawMalignancy, maxRaw);
            generateScoreBreakdown(scores, rawMalignancy, malignancyScore, maxRaw);
            generateBastianAnalysis();
            generateSummary(malignancyScore, scores);
            
            // Scroll to result
            document.getElementById('result').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function generateMorphInterpretation(malignancyScore, scores, rawMalignancy, maxRaw) {
            let interpretation = '';
            let alertClass = '';
            let diagnosis = '';
            let action = '';

            // Red flags check - v3.6.4: wording migliorato
            const redFlags = [];
            if (scores.maturation >= 16) redFlags.push('Maturazione assente/invertita');
            if (scores.mitoses >= 12) redFlags.push('Mitosi ‚â•6/mm¬≤ e/o atipiche');
            if (scores.necrosis >= 5) redFlags.push('Necrosi "en masse"');

            if (redFlags.length > 0) {
                alertClass = 'danger';
                diagnosis = '‚ö†Ô∏è SPITZOID MELANOMA - RED FLAGS PRESENTI';
                action = 'URGENTE: Staging completo, genomica raccomandata, discussione MDT. SNB da valutare in MDT (valore prognostico limitato nelle lesioni spitzoidi)';
                interpretation = `<strong>RED FLAGS IDENTIFICATI:</strong><ul style="margin: 0.5rem 0 0 1.2rem;">`;
                redFlags.forEach(flag => {
                    interpretation += `<li>${flag}</li>`;
                });
                interpretation += `</ul><br><strong>Azione richiesta:</strong> ${action}`;
            } else if (malignancyScore >= 71) {
                alertClass = 'danger';
                diagnosis = 'Spitzoid Melanoma';
                action = 'Staging completo + genomica + discussione MDT';
            } else if (malignancyScore >= 51) {
                alertClass = 'warning';
                diagnosis = 'Atypical Spitz Tumor with concerning features';
                action = 'Genomica raccomandata, SNB da discutere in MDT (valore prognostico limitato), follow-up stretto';
            } else if (malignancyScore >= 31) {
                alertClass = 'warning';
                diagnosis = 'Atypical Spitz Tumor (AST)';
                action = 'Excision completa + follow-up stretto';
            } else {
                alertClass = 'success';
                diagnosis = 'Spitz Nevus';
                action = 'Follow-up clinico routine';
            }

            if (redFlags.length === 0) {
                interpretation = `<strong>Malignancy Score:</strong> ${malignancyScore}/100 <span style="opacity: 0.6; font-size: 0.85em;">(raw: ${rawMalignancy}/${maxRaw})</span><br><strong>Diagnosi suggerita:</strong> ${diagnosis}<br><strong>Raccomandazioni:</strong> ${action}`;
            }

            document.getElementById('morphInterpretation').innerHTML = `
                <div class="interpretation ${alertClass}">
                    ${interpretation}
                </div>
            `;
        }

        function generateScoreBreakdown(scores, rawMalignancy, malignancyScore, maxRaw) {
            const labels = {
                maturation: 'Maturazione A‚ÜíB‚ÜíC',
                symmetry: 'Simmetria',
                circumscription: 'Circoscrizione',
                giant_cells: 'Cellule giganti multinucleate',
                mitoses: 'Mitosi derma profondo',
                infiltration: 'Pattern infiltrazione',
                necrosis: 'Necrosi',
                atypia: 'Atipia nucleare',
                ulceration: 'Ulcerazione'
            };

            const maxScores = {
                maturation: 20,
                symmetry: 15,
                circumscription: 15,
                giant_cells: 8,  // v3.6.4: ridotto da 10 a 8
                mitoses: 15,
                infiltration: 10,
                necrosis: 5,
                atypia: 10,
                ulceration: 5
            };

            let html = '<div class="section-title">Breakdown Punteggi</div>';
            html += `<div style="margin-bottom: 1rem; padding: 0.8rem; background: var(--accent-soft); border-radius: 0.5rem; font-size: 0.85rem;">
                <strong>Sistema di scoring v3.6.6:</strong><br>
                1. Somma punti malignit√† dai dropdown: ${rawMalignancy}/${maxRaw}<br>
                2. <strong>Normalizza a 0-100: ${malignancyScore}/100 = round((${rawMalignancy}/${maxRaw}) √ó 100)</strong><br>
                <em style="opacity: 0.8;">‚úÖ INTUITIVO: Selezioni ALTE nei dropdown ‚Üí Score ALTO ‚Üí Melanoma | Selezioni BASSE ‚Üí Score BASSO ‚Üí Spitz</em>
            </div>`;
            html += '<table class="breakdown-table"><thead><tr><th>Criterio</th><th>Malignit√†</th><th>Max</th><th>Status</th></tr></thead><tbody>';

            for (const [key, value] of Object.entries(scores)) {
                const max = maxScores[key];
                const percentage = (value / max) * 100;
                let status = '';
                let chipClass = '';

                if (percentage <= 30) {
                    status = 'Benigno';
                    chipClass = 'chip-ok';
                } else if (percentage <= 60) {
                    status = 'Intermedio';
                    chipClass = 'chip-warn';
                } else {
                    status = 'Maligno';
                    chipClass = 'chip-danger';
                }

                html += `<tr>
                    <td>${labels[key]}</td>
                    <td><strong>${value}</strong></td>
                    <td>${max}</td>
                    <td><span class="chip ${chipClass}">${status}</span></td>
                </tr>`;
            }

            html += `<tr style="border-top: 2px solid var(--border); font-weight: 600;">
                <td>TOTALE</td>
                <td colspan="2">Raw: ${rawMalignancy}/${maxRaw}</td>
                <td><span class="chip chip-info">Score: ${malignancyScore}/100</span></td>
            </tr>`;
            html += '</tbody></table>';
            document.getElementById('scoreBreakdown').innerHTML = html;
        }
        
        function generateBastianAnalysis() {
            const driverMutation = document.getElementById('bastian_driver').value;
            const cnaProfile = document.getElementById('bastian_cna').value;
            
            let analysis = '<div class="section-title">üß¨ Stratificazione Genetica (Bastian 2014)</div>';
            
            if (!driverMutation && !cnaProfile) {
                analysis += '<div class="alert alert-info">Dati genetici non disponibili. Diagnosi basata su sola morfologia.</div>';
                document.getElementById('bastianAnalysis').innerHTML = analysis;
                return;
            }

            // Driver mutation analysis
            if (driverMutation === 'hras') {
                analysis += `
                    <div class="alert alert-success">
                        <strong>HRAS-mutated Spitz Tumor</strong>
                        <ul style="margin: 0.5rem 0 0 1.2rem;">
                            <li>Profilo genomico: gain 11p come unica aberrazione (tipico)</li>
                            <li><strong>Comportamento:</strong> Low-risk profile</li>
                            <li>Morfologia associata: dome-shaped intradermal lesion</li>
                            <li><strong>Conclusione:</strong> Comportamento biologico benigno atteso</li>
                        </ul>
                        <div style="margin-top: 0.8rem; font-size: 0.75rem; opacity: 0.8;">
                            üìö Bastian BC. Annu Rev Pathol 2014;9:239-271 (pag 254)
                        </div>
                    </div>
                `;
            } else if (driverMutation === 'kinase_fusion') {
                analysis += `
                    <div class="alert alert-info">
                        <strong>Kinase Fusion-driven Spitz Tumor</strong>
                        <ul style="margin: 0.5rem 0 0 1.2rem;">
                            <li>Fusioni: ALK, ROS1, RET, NTRK1, BRAF (60% Spitz tumors)</li>
                            <li>Meccanismo: attivazione costitutiva MAP kinase/PI3K/STAT</li>
                            <li><strong>Comportamento:</strong> Low-to-intermediate risk nella maggioranza</li>
                            <li><strong>Attenzione:</strong> Valutare presenza di CDKN2A loss come evento secondario</li>
                        </ul>
                        <div style="margin-top: 0.8rem; font-size: 0.75rem; opacity: 0.8;">
                            üìö Bastian BC. Annu Rev Pathol 2014;9:239-271 (pag 254)
                        </div>
                    </div>
                `;
            } else if (driverMutation === 'map3k8') {
                analysis += `
                    <div class="alert alert-warning">
                        <strong>MAP3K8 Fusion/Truncation</strong>
                        <ul style="margin: 0.5rem 0 0 1.2rem;">
                            <li>Driver pi√π comune in melanoma spitzoide pediatrico (33%)</li>
                            <li>Partner 3' pi√π frequente: SVIL (46% - Houlier 2020)</li>
                            <li><strong>CDKN2A inactivation:</strong> 77% casi atipici/maligni (Houlier 2020), 82% p16 loss (Newman AJSP 2019)</li>
                            <li><strong>Features morfologiche:</strong> ulcerazione 32%, giant multinucleated cells</li>
                            <li><strong>Target terapeutico:</strong> Risposta a MEK inhibitors (Newman Nat Med 2019)</li>
                            <li><strong>‚ö†Ô∏è Comportamento variabile:</strong> Richiede correlazione clinico-patologica stretta</li>
                        </ul>
                        <div style="margin-top: 0.8rem; font-size: 0.75rem; opacity: 0.8;">
                            üìö Newman S et al. Nat Med 2019;25:597-602<br>
                            üìö Newman S et al. Am J Surg Pathol 2019;43:1631-1637<br>
                            üìö Houlier A et al. Mod Pathol 2020;33:846-857
                        </div>
                    </div>
                `;
            } else if (driverMutation === 'braf_bap1') {
                analysis += `
                    <div class="alert alert-warning">
                        <strong>BRAF V600E + BAP1 loss</strong>
                        <ul style="margin: 0.5rem 0 0 1.2rem;">
                            <li>Subset: BRAF V600E + BAP1 loss biallelic</li>
                            <li>Morfologia: intradermal dome-shaped</li>
                            <li><strong>BAP1 germline:</strong> Causa atypical Spitz tumors</li>
                            <li><strong>‚ö†Ô∏è Nota critica:</strong> Bastian 2014 "not clear-cut melanoma" da solo</li>
                            <li><strong>Comportamento:</strong> Potenziale intermedio, serve follow-up</li>
                        </ul>
                        <div style="margin-top: 0.8rem; font-size: 0.75rem; opacity: 0.8;">
                            üìö Bastian BC. Annu Rev Pathol 2014;9:239-271 (pag 254)
                        </div>
                    </div>
                `;
            } else if (driverMutation === 'tert') {
                analysis += `
                    <div class="alert alert-danger">
                        <strong>‚ö†Ô∏è TERT Promoter Mutation - Criterio Solido Malignit√†</strong>
                        <ul style="margin: 0.5rem 0 0 1.2rem;">
                            <li><strong>Epidemiologia:</strong> 85% metastasi vs 0% nevi (Bastian 2014, pag 250-251)</li>
                            <li><strong>Significato:</strong> "Emerging as critical barrier" nella progressione maligna</li>
                            <li><strong>Presente in:</strong> 33% melanomi primari</li>
                            <li><strong>‚ö†Ô∏è NON override assoluto:</strong> Richiede correlazione clinica</li>
                            <li><strong>Interpretazione:</strong> Indicatore robusto ma non matematico di malignit√†</li>
                            <li><strong>Azione consigliata:</strong> Diagnosi di melanoma in contesto clinico-patologico appropriato</li>
                        </ul>
                        <div style="margin-top: 0.8rem; font-size: 0.75rem; opacity: 0.8;">
                            üìö Bastian BC. Annu Rev Pathol 2014;9:239-271 (pag 250-251)
                        </div>
                    </div>
                `;
            } else if (driverMutation === 'gnaq_gna11') {
                analysis += `
                    <div class="alert alert-info">
                        <strong>GNAQ/GNA11 Mutation (Q209)</strong>
                        <ul style="margin: 0.5rem 0 0 1.2rem;">
                            <li>Caratteristico di: blue nevi, uveal melanoma</li>
                            <li>Meccanismo: loss of GTPase activity</li>
                            <li><strong>Contesto clinico:</strong> NON tipico di Spitz melanoma</li>
                            <li><strong>Nota:</strong> Se presente in lesione spitzoide ‚Üí considerare diagnosi alternativa</li>
                        </ul>
                        <div style="margin-top: 0.8rem; font-size: 0.75rem; opacity: 0.8;">
                            üìö Bastian BC. Annu Rev Pathol 2014;9:239-271 (pag 262-263)
                        </div>
                    </div>
                `;
            } else if (driverMutation === 'cdkn2a_only') {
                analysis += `
                    <div class="alert alert-warning">
                        <strong>CDKN2A (p16) Loss Isolato</strong>
                        <ul style="margin: 0.5rem 0 0 1.2rem;">
                            <li><strong>‚ö†Ô∏è NON diagnostico da solo</strong> (Bastian 2014, pag 243-244)</li>
                            <li>Evento secondario oncogenico presente in:</li>
                            <ul style="margin: 0.3rem 0 0 1.5rem;">
                                <li>All melanoma types</li>
                                <li>Dysplastic nevi</li>
                                <li>Atypical Spitz tumors</li>
                            </ul>
                            <li><strong>Interpretazione:</strong> Marker di atipia, non sufficiente per diagnosi melanoma</li>
                            <li><strong>Contesto MAP3K8:</strong> 77% inactivation in casi atipici/maligni (Houlier 2020), 82% p16 loss (Newman AJSP 2019)</li>
                            <li><strong>Azione:</strong> Considerare nel contesto di altri criteri morfologici e genetici</li>
                        </ul>
                        <div style="margin-top: 0.8rem; font-size: 0.75rem; opacity: 0.8;">
                            üìö Bastian BC. Annu Rev Pathol 2014;9:239-271 (Table 3, pag 243-244)<br>
                            üìö Houlier A et al. Mod Pathol 2020;33:846-857<br>
                            üìö Newman S et al. Am J Surg Pathol 2019;43:1631-1637
                        </div>
                    </div>
                `;
            }
            
            // CNA Profile analysis
            if (cnaProfile === 'single_gain') {
                analysis += `
                    <div class="alert alert-success">
                        <strong>CNA Profile: Single Copy Number Gain</strong>
                        <ul style="margin: 0.5rem 0 0 1.2rem;">
                            <li>Profilo genomico stabile</li>
                            <li><strong>Tipico di:</strong> HRAS-mutated Spitz (gain 11p)</li>
                            <li><strong>Interpretazione:</strong> Low-risk biological behavior</li>
                        </ul>
                    </div>
                `;
            } else if (cnaProfile === 'multiple_cna') {
                analysis += `
                    <div class="alert alert-danger">
                        <strong>CNA Profile: Multiple Copy Number Aberrations</strong>
                        <ul style="margin: 0.5rem 0 0 1.2rem;">
                            <li><strong>‚ö†Ô∏è Red flag genomico</strong></li>
                            <li>Instabilit√† genomica (Bastian 2014, pag 259)</li>
                            <li>Tipico di: acral/mucosal melanomas (avg 5 amplifications)</li>
                            <li><strong>Interpretazione:</strong> Forte indicatore malignit√†</li>
                            <li><strong>‚ö†Ô∏è Incompatibile con diagnosi Spitz benigno</strong></li>
                        </ul>
                        <div style="margin-top: 0.8rem; font-size: 0.75rem; opacity: 0.8;">
                            üìö Bastian BC. Annu Rev Pathol 2014;9:239-271 (pag 259)
                        </div>
                    </div>
                `;
            } else if (cnaProfile === 'chr_6_loss') {
                analysis += `
                    <div class="alert alert-danger">
                        <strong>CNA Profile: Chromosome 6 Loss</strong>
                        <ul style="margin: 0.5rem 0 0 1.2rem;">
                            <li><strong>‚ö†Ô∏è Marker established di malignit√†</strong></li>
                            <li>Associato a progressione melanoma</li>
                            <li><strong>Interpretazione:</strong> Fortemente suggestivo comportamento maligno</li>
                        </ul>
                    </div>
                `;
            }
            
            document.getElementById('bastianAnalysis').innerHTML = analysis;
        }

        function generateSummary(normalizedScore, scores) {
            const driverMutation = document.getElementById('bastian_driver').value;
            const cnaProfile = document.getElementById('bastian_cna').value;

            let summary = '<div class="section-title">üìã Sommario Integrato</div>';
            
            summary += `<div class="alert alert-info">
                <strong>Score Morfologico Normalizzato:</strong> ${normalizedScore}/100<br>
                <strong>Driver Mutation:</strong> ${driverMutation || 'Non disponibile'}<br>
                <strong>CNA Profile:</strong> ${cnaProfile || 'Non disponibile'}
            </div>`;

            // Integrazione morfologia + genetica
            let finalDiagnosis = '';
            let confidence = '';
            let refertableSentence = '';

            if (driverMutation === 'tert' || cnaProfile === 'multiple_cna' || cnaProfile === 'chr_6_loss') {
                finalDiagnosis = '‚ö†Ô∏è MELANOMA - Criteri solidi genetici presenti';
                confidence = 'Alta (genomica supporta malignit√†)';
                refertableSentence = 'Melanoma spitzoide con alterazioni genetiche associate a comportamento biologico aggressivo.';
            } else if (normalizedScore >= 71) {
                finalDiagnosis = 'Spitzoid Melanoma (morfologia)';
                confidence = driverMutation ? 'Moderata-Alta' : 'Moderata (solo morfologia)';
                refertableSentence = 'Lesione melanocitica spitzoide con caratteristiche morfologiche fortemente suggestive di melanoma.';
            } else if (normalizedScore >= 51) {
                finalDiagnosis = 'Atypical Spitz Tumor with concerning features';
                confidence = 'Moderata (genomica raccomandata)';
                refertableSentence = 'Lesione melanocitica spitzoide con caratteristiche morfologiche e/o genetiche associate a comportamento biologico potenzialmente aggressivo.';
            } else if (driverMutation === 'hras' && cnaProfile === 'single_gain') {
                finalDiagnosis = 'Spitz Nevus (HRAS low-risk profile)';
                confidence = 'Alta (morfologia + genetica concordanti)';
            } else if (normalizedScore <= 30 && !driverMutation) {
                finalDiagnosis = 'Spitz Nevus';
                confidence = 'Moderata-Alta';
            } else {
                finalDiagnosis = 'Atypical Spitz Tumor';
                confidence = 'Moderata';
                refertableSentence = 'Tumore di Spitz atipico; si raccomanda correlazione clinica e considerare approfondimento genetico.';
            }

            summary += `<div class="alert alert-warning">
                <strong>Diagnosi Finale Integrata:</strong> ${finalDiagnosis}<br>
                <strong>Livello di Confidenza:</strong> ${confidence}<br>
                ${refertableSentence ? `<br><strong>üìù Frase refertabile suggerita:</strong><br><em>"${refertableSentence}"</em><br>` : ''}
                <br>
                <strong>‚ö†Ô∏è REMINDER:</strong> Diagnosi finale richiede correlazione clinica, revisione morfologica esperta, 
                e contestualizzazione del caso specifico. Il tool √® un ausilio decisionale, non sostituisce il giudizio del patologo.
            </div>`;

            // Warning overconfidence per score bassi
            if (normalizedScore <= 30) {
                summary += `<div class="alert alert-info" style="border-color: #17a2b8;">
                    <strong>‚ö†Ô∏è ATTENZIONE - Score basso:</strong><br>
                    Uno score basso (‚â§30) <strong>non esclude</strong> la necessit√† di rivalutazione in caso di:
                    <ul style="margin: 0.5rem 0 0 1.2rem;">
                        <li><strong>Discordanza clinica:</strong> lesione clinicamente atipica o in crescita</li>
                        <li><strong>Campionamento limitato:</strong> biopsia parziale, shave superficiale</li>
                        <li><strong>Et√†/sede atipiche:</strong> adulto >40 anni, sedi non classiche</li>
                        <li><strong>Recidiva locale:</strong> dopo precedente escissione</li>
                    </ul>
                    <em>In caso di dubbio: second opinion esperta e/o approfondimento genetico.</em>
                </div>`;
            }

            // Nota SNB per score alti
            if (normalizedScore >= 51 || driverMutation === 'map3k8') {
                summary += `<div class="alert alert-info" style="border-color: #6c757d; background: #f8f9fa;">
                    <strong>üìã Nota su Sentinel Node Biopsy:</strong><br>
                    La SNB nelle lesioni spitzoidi ha <strong>valore prognostico limitato</strong>:
                    <ul style="margin: 0.5rem 0 0 1.2rem;">
                        <li>Positivit√† linfonodale frequente anche in AST con decorso benigno</li>
                        <li>In casi pediatrici/MAP3K8: pu√≤ dare falsi segnali prognostici</li>
                        <li><strong>Decisione da discutere sempre in MDT</strong>, bilanciando rischi/benefici</li>
                    </ul>
                    <em style="font-size: 0.8rem;">Ref: Ludgate et al. J Clin Oncol 2009; Lallas et al. JAAD 2014</em>
                </div>`;
            }

            document.getElementById('summaryContent').innerHTML = summary;
        }

        // ========== BIBLIOGRAFIA FUNCTIONS ==========
        function renderBibliography() {
            const container = document.getElementById('bibliographyCards');
            container.innerHTML = '';
            
            bibliography.forEach(bib => {
                const card = document.createElement('div');
                card.className = 'bib-card';
                card.dataset.category = bib.category;
                card.dataset.id = bib.id;
                
                card.innerHTML = `
                    <div class="bib-header" onclick="toggleBibCard('${bib.id}')">
                        <div class="bib-citation">
                            <strong>${bib.authors}</strong> (${bib.year}). 
                            ${bib.title}.
                            <em>${bib.journal}</em>${bib.volume ? ` ${bib.volume}` : ''}${bib.pages ? `:${bib.pages}` : ''}.
                        </div>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                    
                    <div class="bib-content">
                        <div class="bib-findings">
                            <strong>Key Findings:</strong> ${bib.keyFindings}
                        </div>
                        
                        <div class="bib-chips">
                            <span class="chip chip-${bib.category === 'genetica' ? 'ok' : bib.category === 'morfologia' ? 'warn' : 'info'}">
                                ${bib.category.charAt(0).toUpperCase() + bib.category.slice(1)}
                            </span>
                            ${bib.supportedCriteria.map(c => `<span class="chip">${c}</span>`).join('')}
                        </div>
                        
                        <div class="bib-links">
                            ${bib.doi ? `<a href="https://doi.org/${bib.doi}" target="_blank">üìÑ DOI</a>` : ''}
                            ${bib.pmid ? `<a href="https://pubmed.ncbi.nlm.nih.gov/${bib.pmid}/" target="_blank">üî¨ PubMed</a>` : ''}
                            ${bib.url && !bib.doi ? `<a href="${bib.url}" target="_blank">üîó Link</a>` : ''}
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }
        
        function toggleBibCard(id) {
            const card = document.querySelector(`.bib-card[data-id="${id}"]`);
            card.classList.toggle('expanded');
        }
        
        function filterBibByCategory(category) {
            document.querySelectorAll('.bib-filter').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === category);
            });
            
            document.querySelectorAll('.bib-card').forEach(card => {
                if (category === 'all' || card.dataset.category === category) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        function filterBibliography() {
            const search = document.getElementById('bibSearch').value.toLowerCase();
            
            document.querySelectorAll('.bib-card').forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(search) ? 'block' : 'none';
            });
        }
        
        function exportBibTeX() {
            let bibtex = '';
            bibliography.forEach(bib => {
                bibtex += bib.bibtex + '\n\n';
            });
            
            const blob = new Blob([bibtex], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'spitz_melanoma_bibliography.bib';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // v3.6.5: showBibCard refactored - usa switchTab() direttamente
        function showBibCard(id) {
            // Switch to bibliography tab using switchTab directly
            switchTab(null, 'bibliography');
            
            // Activate the correct tab button
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent.trim() === 'Bibliografia') {
                    tab.classList.add('active');
                }
            });
            
            setTimeout(() => {
                const card = document.querySelector(`.bib-card[data-id="${id}"]`);
                if (card) {
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    card.classList.add('expanded');
                }
            }, 100);
        }

        // ========== TAB SWITCHING ==========
        function switchTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            if (event && event.target) event.target.classList.add('active');
        }

        // ========== UTILITY FUNCTIONS ==========
        function exportPDF() {
            const element = document.getElementById('result');
            const opt = {
                margin: 1,
                filename: `spitz-melanoma-report-${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        function resetForm() {
            document.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
            });
            document.getElementById('result').style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ========== INIT ==========
        document.addEventListener('DOMContentLoaded', function() {
            renderBibliography();
        });
    </script>
</body>
</html>
