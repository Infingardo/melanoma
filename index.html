<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filippo's Diagnostic Algorithm</title>
    <meta name="description" content="Algoritmo diagnostico personalizzato Spitz vs Melanoma con stratificazione Bastian">
    <meta name="author" content="Dr. Filippo Bianchi - SC Anatomia Patologica Fatebenefratelli Milano">
    <style>
        :root {
            --bg: #f8f9fa;
            --bg-card: #ffffff;
            --border: #e8eaed;
            --border-subtle: #efefef;
            --accent: #2563eb;
            --accent-soft: rgba(37,99,235,0.08);
            --danger: #dc2626;
            --danger-soft: rgba(220,38,38,0.08);
            --warn: #d97706;
            --warn-soft: rgba(217,119,6,0.08);
            --ok: #16a34a;
            --ok-soft: rgba(22,163,74,0.08);
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --chip-bg: #f3f4f6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
            background: var(--bg);
            color: var(--text-main);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2.5rem 1.25rem 3.5rem;
        }

        header {
            margin-bottom: 2.5rem;
        }

        h1 {
            font-size: 1.9rem;
            margin-bottom: 0.25rem;
            letter-spacing: 0.02em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-main);
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 0.95rem;
            margin-top: 0.5rem;
        }

        .disclaimer {
            background: linear-gradient(135deg, var(--accent-soft), rgba(37,99,235,0.04));
            border: 1px solid rgba(37,99,235,0.2);
            border-radius: 0.9rem;
            padding: 1.2rem;
            margin-bottom: 2rem;
            font-size: 0.85rem;
            line-height: 1.5;
            color: var(--text-main);
        }

        .disclaimer strong {
            color: var(--accent);
        }

        .grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 1000px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--bg-card);
            border-radius: 1rem;
            padding: 1.6rem;
            border: 1px solid var(--border);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 1rem;
            margin-top: 1.2rem;
            font-weight: 600;
        }

        .section-title:first-child {
            margin-top: 0;
        }

        .field-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.9rem 1.2rem;
            margin-bottom: 0.6rem;
        }

        label {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            font-size: 0.8rem;
        }

        .label-main {
            font-weight: 500;
            color: var(--text-main);
        }

        .label-hint {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        select, input {
            width: 100%;
            border-radius: 0.6rem;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-main);
            font-size: 0.9rem;
            padding: 0.5rem 0.6rem;
            outline: none;
            transition: border-color 0.15s, box-shadow 0.15s;
        }

        select:focus, input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-soft);
        }

        .btn-group {
            display: flex;
            gap: 0.8rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        button {
            border-radius: 0.7rem;
            border: none;
            font-size: 0.9rem;
            padding: 0.65rem 1.3rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), #1d4ed8);
            color: white;
            box-shadow: 0 2px 8px rgba(37,99,235,0.2);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37,99,235,0.3);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--chip-bg);
            border: 1px solid var(--border);
            color: var(--text-main);
        }

        .btn-secondary:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .result-section {
            display: none;
        }

        .result-section.active {
            display: block;
        }

        .result-card {
            background: var(--bg-card);
            border-radius: 1rem;
            padding: 1.6rem;
            border: 1px solid var(--border);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .classification {
            font-size: 1.6rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin-bottom: 0.8rem;
            flex-wrap: wrap;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            border-radius: 999px;
            padding: 0.25rem 0.9rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border: 1px solid;
            font-weight: 600;
        }

        .badge-zero {
            border-color: var(--ok);
            background: var(--ok-soft);
            color: var(--ok);
        }

        .badge-low {
            border-color: var(--ok);
            background: var(--ok-soft);
            color: var(--ok);
        }

        .badge-mid {
            border-color: var(--warn);
            background: var(--warn-soft);
            color: var(--warn);
        }

        .badge-high {
            border-color: var(--danger);
            background: var(--danger-soft);
            color: var(--danger);
        }

        .badge-critical {
            border-color: var(--danger);
            background: var(--danger-soft);
            color: var(--danger);
        }

        .result-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin: 1rem 0;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .explanations {
            font-size: 0.85rem;
            line-height: 1.6;
            color: var(--text-main);
            margin-top: 1rem;
        }

        .explanations ul {
            margin: 0.6rem 0 0;
            padding-left: 1.2rem;
        }

        .explanations li {
            margin-bottom: 0.35rem;
        }

        .chips-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .chip {
            font-size: 0.7rem;
            background: var(--chip-bg);
            color: var(--text-muted);
            border-radius: 999px;
            padding: 0.25rem 0.7rem;
            border: 1px solid var(--border-subtle);
            white-space: nowrap;
        }

        .chip-ok {
            border-color: var(--ok);
            background: var(--ok-soft);
            color: var(--ok);
        }

        .chip-warn {
            border-color: var(--warn);
            background: var(--warn-soft);
            color: var(--warn);
        }

        .chip-danger {
            border-color: var(--danger);
            background: var(--danger-soft);
            color: var(--danger);
        }

        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid var(--border);
            margin-bottom: 1.5rem;
            margin: 0 -1.6rem 1.5rem;
            padding: 0 1.6rem;
        }

        .tab {
            padding: 0.8rem 1.2rem;
            border-bottom: 3px solid transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
            margin-bottom: -2px;
        }

        .tab:hover {
            color: var(--text-main);
        }

        .tab.active {
            border-bottom-color: var(--accent);
            color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .footer-note {
            margin-top: 3rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            line-height: 1.6;
            border-top: 1px solid var(--border);
            padding-top: 1.5rem;
        }

        .empty-state {
            text-align: center;
            color: var(--text-muted);
            padding: 2rem 1rem;
        }

        .empty-state-icon {
            font-size: 2.5rem;
            margin-bottom: 0.8rem;
            opacity: 0.6;
        }

        @media (max-width: 700px) {
            .container {
                padding: 1.5rem 1rem 2.5rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .field-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <header>
            <h1>üß¨ Filippo's Diagnostic Algorithm</h1>
            <p class="subtitle">Spitz vs Melanoma: Morfologia + Genetica (Bastian Classification)</p>
        </header>

        <!-- DISCLAIMER -->
        <div class="disclaimer">
            <strong>‚ö†Ô∏è Metodologia:</strong> Approccio olistico (Massi & Leboit, 2016) + Stratificazione genetica (Bastian 2024).
            La diagnosi finale richiede giudizio clinico esperto. Nessun algoritmo sostituisce l'esperienza del patologo.
        </div>

        <!-- MAIN GRID -->
        <div class="grid">
            <!-- LEFT: INPUT FORM -->
            <div>
                <div class="card">
                    <div class="section-title">üìã Valutazione Morfologica (Step 0-8)</div>

                    <!-- STEP 0: ETA' -->
                    <div class="section-title" style="margin-top: 0.8rem;">Gate 0: Et√† del Paziente (FONDAMENTALE)</div>
                    <div class="field-group">
                        <label>
                            <span class="label-main">Et√†</span>
                            <select id="age">
                                <option value="">-- Seleziona --</option>
                                <option value="child">üü¢ &lt; 20 anni (Spitz pi√π probabile)</option>
                                <option value="young">üü° 20-40 anni (Zona grigia)</option>
                                <option value="adult">üü° 40-60 anni (Cautela)</option>
                                <option value="elderly">üö® &gt; 60 anni (Melanoma pi√π probabile)</option>
                            </select>
                        </label>
                    </div>

                    <!-- STEP 1: ASIMMETRIA -->
                    <div class="section-title" style="margin-top: 0.8rem;">Gate 1: Asimmetria</div>
                    <div class="field-group">
                        <label>
                            <span class="label-main">Simmetria</span>
                            <select id="asymmetry">
                                <option value="">-- Seleziona --</option>
                                <option value="symmetric">‚úÖ Simmetrica</option>
                                <option value="partial">‚ö†Ô∏è Parziale</option>
                                <option value="marked">üö® Marcata asimmetria</option>
                            </select>
                        </label>
                    </div>

                    <!-- STEP 2: MATURAZIONE -->
                    <div class="section-title">Gate 2: Maturazione (CRITICAL)</div>
                    <div class="field-group">
                        <label>
                            <span class="label-main">Pattern A‚ÜíB‚ÜíC</span>
                            <span class="label-hint">A=piccole superficiali | B=medie intermedie | C=grandi profonde (maturazione = ‚úÖ)</span>
                            <select id="maturation">
                                <option value="">-- Seleziona --</option>
                                <option value="complete">‚úÖ Completa (>80%)</option>
                                <option value="incomplete">‚ö†Ô∏è Incompleta (40-80%)</option>
                                <option value="absent">üö® Assente/Invertita</option>
                            </select>
                        </label>
                    </div>

                    <!-- STEP 3: MORFOLOGIA -->
                    <div class="section-title">Gate 3: Morfologia Citologica</div>
                    <div class="field-group">
                        <label>
                            <span class="label-main">Uniformit√†</span>
                            <select id="morphology">
                                <option value="">-- Seleziona --</option>
                                <option value="monomorphic">‚úÖ Monomorfo</option>
                                <option value="moderate">‚ö†Ô∏è Pleomorfismo moderato</option>
                                <option value="marked">üö® Marcato pleomorfismo</option>
                            </select>
                        </label>
                    </div>

                    <!-- STEP 4: MITOSI -->
                    <div class="section-title">Gate 4: Mitosi (Count + Location)</div>
                    <div class="field-group">
                        <label>
                            <span class="label-main">Count /mm¬≤</span>
                            <select id="mitoses_count">
                                <option value="">-- Seleziona --</option>
                                <option value="low">&lt; 3 mitosi</option>
                                <option value="moderate">3-6 mitosi</option>
                                <option value="high">‚â• 6 mitosi üö®</option>
                            </select>
                        </label>

                        <label>
                            <span class="label-main">Localizzazione</span>
                            <select id="mitoses_location">
                                <option value="">-- Seleziona --</option>
                                <option value="peripheral">‚úÖ Periferica/Superficiale</option>
                                <option value="deep">üö® Profonda</option>
                                <option value="na">N/A (< 3 mitosi)</option>
                            </select>
                        </label>
                    </div>

                    <!-- STEP 5: ATIPIE MITOTICA -->
                    <div class="section-title">Gate 5: Atipie Mitotica (OVERRIDE)</div>
                    <div class="field-group">
                        <label>
                            <span class="label-main">Mitosi Atipiche</span>
                            <select id="atypical_mitoses">
                                <option value="">-- Seleziona --</option>
                                <option value="absent">‚úÖ Assenti</option>
                                <option value="rare">‚ö†Ô∏è Rare/Dubbie</option>
                                <option value="present">üö® Presenti (OVERRIDE‚ÜíMELANOMA)</option>
                            </select>
                        </label>
                    </div>

                    <!-- STEP 6: INFILTRAZIONE -->
                    <div class="section-title">Gate 6: Infiltrazione</div>
                    <div class="field-group">
                        <label>
                            <span class="label-main">Pattern Crescita</span>
                            <select id="infiltration">
                                <option value="">-- Seleziona --</option>
                                <option value="circumscribed">‚úÖ Circoscritto</option>
                                <option value="partial">‚ö†Ô∏è Parzialmente infiltrativo</option>
                                <option value="infiltrative">üö® Marcatamente infiltrativo</option>
                            </select>
                        </label>
                    </div>

                    <!-- STEP 7: IHC -->
                    <div class="section-title">Gate 7: IHC (Spreading Pattern)</div>
                    <div class="field-group">
                        <label>
                            <span class="label-main">Spreading Intraepidermico</span>
                            <select id="spreading_pattern">
                                <option value="">-- Seleziona --</option>
                                <option value="absent">‚úÖ Assente/Focale</option>
                                <option value="partial">‚ö†Ô∏è Parziale/Multifocale</option>
                                <option value="diffuse">üö® Diffuso</option>
                            </select>
                        </label>

                        <label>
                            <span class="label-main">p16</span>
                            <select id="p16">
                                <option value="">-- Seleziona --</option>
                                <option value="present">‚úÖ Mantenuto</option>
                                <option value="partial">‚ö†Ô∏è Perdita focale</option>
                                <option value="loss">üö® Perdita completa</option>
                            </select>
                        </label>
                    </div>

                    <!-- STEP 8: Ki-67 -->
                    <div class="section-title">Gate 8: Ki-67 (Location Matters)</div>
                    <div class="field-group">
                        <label>
                            <span class="label-main">Indice Proliferativo %</span>
                            <select id="ki67_count">
                                <option value="">-- Seleziona --</option>
                                <option value="low">‚úÖ &lt; 5%</option>
                                <option value="intermediate">‚ö†Ô∏è 5-15%</option>
                                <option value="high">‚ö†Ô∏è &gt; 15-20%</option>
                            </select>
                        </label>

                        <label>
                            <span class="label-main">Localizzazione</span>
                            <select id="ki67_location">
                                <option value="">-- Seleziona --</option>
                                <option value="peripheral">‚úÖ Periferico</option>
                                <option value="central">‚ö†Ô∏è Centrale</option>
                                <option value="deep">üö® Profondo</option>
                                <option value="na">N/A (Ki-67 basso)</option>
                            </select>
                        </label>
                    </div>

                    <!-- BUTTONS -->
                    <div class="btn-group">
                        <button class="btn-primary" onclick="calculateDiagnosis()">
                            üìä Calcola Diagnosi Morfologica
                        </button>
                        <button class="btn-secondary" onclick="resetForm()">
                            üîÑ Reset
                        </button>
                    </div>
                </div>
            </div>

            <!-- RIGHT: RESULTS -->
            <div>
                <!-- MORPHOLOGICAL RESULT -->
                <div id="morphResult" class="result-section">
                    <div class="result-card">
                        <div class="tabs">
                            <div class="tab active" onclick="switchTab(event, 'morph')">Morfologia</div>
                            <div class="tab" onclick="switchTab(event, 'bastian')">Genetica</div>
                        </div>

                        <div id="morph" class="tab-content active">
                            <div class="classification" id="morphDiagnosis"></div>
                            <div class="result-meta" id="morphMeta"></div>
                            <div class="explanations" id="morphExplanations"></div>
                        </div>

                        <div id="bastian" class="tab-content">
                            <div id="bastianSection">
                                <div class="section-title" style="margin-top: 0;">üß¨ Stratificazione Genetica</div>
                                <div class="field-group" style="grid-template-columns: 1fr;">
                                    <label>
                                        <span class="label-main">Driver Mutazionale</span>
                                        <select id="bastian_driver" onchange="updateBastianPreview()">
                                            <option value="">-- Seleziona --</option>
                                            <optgroup label="üü¢ SPITZ-LIKE (Low-Risk)">
                                                <option value="hras_mut">HRAS-mutated</option>
                                                <option value="alk_fusion">ALK fusion</option>
                                                <option value="ros1_fusion">ROS1 fusion</option>
                                                <option value="ntrk_fusion">NTRK1/3 fusion</option>
                                                <option value="ret_fusion">RET fusion</option>
                                                <option value="braf_fusion">BRAF-fusion (eterogeneo)</option>
                                            </optgroup>
                                            <optgroup label="üö® RED FLAG (Melanoma-Like)">
                                                <option value="map3k8_fusion">MAP3K8 fusion</option>
                                                <option value="braf_v600">BRAF V600E/K</option>
                                                <option value="nras_q61">NRAS Q61</option>
                                                <option value="nf1_loss">NF1 loss</option>
                                                <option value="tert_promoter">‚ö†Ô∏è TERT promoter (CRITERIO DURO)</option>
                                                <option value="cdkn2a_loss">‚ö†Ô∏è CDKN2A loss (CRITERIO DURO)</option>
                                            </optgroup>
                                        </select>
                                    </label>

                                    <label>
                                        <span class="label-main">CNA Profile</span>
                                        <select id="bastian_cna" onchange="updateBastianPreview()">
                                            <option value="">-- Seleziona --</option>
                                            <option value="none">üü¢ Assente/Calmo</option>
                                            <option value="limited">üü° Limitati</option>
                                            <option value="complex">üö® Complessi</option>
                                        </select>
                                    </label>
                                </div>

                                <button class="btn-primary" onclick="applyBastian()" style="margin-top: 1rem; width: 100%;">
                                    üß¨ Applica Stratificazione Bastian
                                </button>
                            </div>

                            <div id="bastianResult" style="display: none;">
                                <div class="classification" id="bastianDiagnosis"></div>
                                <div class="explanations" id="bastianExplanations"></div>
                                <div class="chips-row" id="bastianChips"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- EMPTY STATE -->
                <div id="emptyState" class="result-card empty-state">
                    <div class="empty-state-icon">üìã</div>
                    <div>Compila i criteri morfologici e clicca "Calcola"</div>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="footer-note">
            <strong>Metodologia:</strong> Approccio olistico (Massi & Leboit, <em>Ackerman's Pathology of the Skin, 3rd Edition</em>, 2016) + Stratificazione genetica (Bastian 2024).
            Basato su approccio diagnostico personalizzato di Dr. Filippo Bianchi. 
            La diagnosi definitiva richiede integrazione con giudizio clinico esperto.
            <br><br>
            <strong>Fonte primaria:</strong> Massi G, Leboit PE. <em>Histopathology of Cutaneous Melanoma and Other Melanocytic Lesions</em>. In: Ackerman AB, editor. <em>Ackerman's Pathology of the Skin</em>. 3rd ed. New York: Elsevier; 2016. | Bastian BC et al. Genomic classification of spitzoid tumors (2024).
        </div>
    </div>

    <script>
        function calculateDiagnosis() {
            const inputs = {
                age: document.getElementById('age').value,
                asymmetry: document.getElementById('asymmetry').value,
                maturation: document.getElementById('maturation').value,
                morphology: document.getElementById('morphology').value,
                mitoses_count: document.getElementById('mitoses_count').value,
                mitoses_location: document.getElementById('mitoses_location').value,
                atypical_mitoses: document.getElementById('atypical_mitoses').value,
                infiltration: document.getElementById('infiltration').value,
                spreading_pattern: document.getElementById('spreading_pattern').value,
                p16: document.getElementById('p16').value,
                ki67_count: document.getElementById('ki67_count').value,
                ki67_location: document.getElementById('ki67_location').value,
            };

            // Validate
            if (Object.values(inputs).filter(v => v === '').length > 3) {
                alert('Compila almeno il 70% dei criteri');
                return;
            }

            let redFlags = [];
            let yellowFlags = [];
            let greenFlags = [];
            let diagnosis = '';
            let badgeClass = '';

            // AGE GATE (Gate 0)
            if (inputs.age === 'child') {
                greenFlags.push('Et√† < 20 anni (Spitz pi√π probabile)');
            } else if (inputs.age === 'young' || inputs.age === 'adult') {
                yellowFlags.push(`Et√† ${inputs.age === 'young' ? '20-40' : '40-60'} anni (zona grigia - attenzione)`);
            } else if (inputs.age === 'elderly') {
                redFlags.push('Et√† > 60 anni (melanoma pi√π probabile)');
            }

            // GATE LOGIC
            if (inputs.asymmetry === 'marked') redFlags.push('Asimmetria marcata');
            if (inputs.asymmetry === 'symmetric') greenFlags.push('Lesione simmetrica');

            if (inputs.maturation === 'absent') redFlags.push('Maturazione assente (CRITICAL)');
            if (inputs.maturation === 'complete') greenFlags.push('Maturazione A‚ÜíB‚ÜíC presente');

            if (inputs.morphology === 'marked') redFlags.push('Pleomorfismo marcato');
            if (inputs.morphology === 'monomorphic') greenFlags.push('Citologia monomorfa');

            if (inputs.atypical_mitoses === 'present') {
                redFlags.push('üö® MITOSI ATIPICHE = OVERRIDE MELANOMA');
                diagnosis = 'üö® MELANOMA';
                badgeClass = 'badge-critical';
            }

            if (inputs.mitoses_count === 'high') redFlags.push('‚â•6 mitosi/mm¬≤');
            if (inputs.mitoses_count === 'low') greenFlags.push('< 3 mitosi/mm¬≤');

            if (inputs.mitoses_location === 'deep' && inputs.mitoses_count === 'moderate') {
                redFlags.push('Mitosi profonde');
            } else if (inputs.mitoses_location === 'peripheral' && inputs.mitoses_count === 'moderate') {
                greenFlags.push('Mitosi periferiche (OK pattern Spitz)');
            }

            if (inputs.spreading_pattern === 'diffuse' && inputs.p16 === 'loss') {
                redFlags.push('üö® Spreading diffuso + p16 loss');
                diagnosis = 'üö® MELANOMA';
                badgeClass = 'badge-critical';
            }

            if (inputs.spreading_pattern === 'absent') greenFlags.push('Spreading assente');

            if (inputs.ki67_count === 'high' && inputs.ki67_location === 'deep') {
                redFlags.push('Ki-67 alto profondo');
            } else if (inputs.ki67_count === 'high' && inputs.ki67_location === 'peripheral') {
                greenFlags.push('Ki-67 alto periferico (growth phase OK)');
            }

            // DIAGNOSIS LOGIC
            if (!diagnosis) {
                if (redFlags.length >= 3) {
                    diagnosis = 'üö® MELANOMA PROBABILE';
                    badgeClass = 'badge-high';
                } else if (redFlags.length === 2 && inputs.atypical_mitoses !== 'present') {
                    diagnosis = '‚ö†Ô∏è SPITZ ATIPICO';
                    badgeClass = 'badge-mid';
                } else if (redFlags.length <= 1 && greenFlags.length >= 4) {
                    diagnosis = '‚úÖ SPITZ BENIGNO';
                    badgeClass = 'badge-low';
                } else {
                    diagnosis = '‚ö†Ô∏è BORDERLINE';
                    badgeClass = 'badge-mid';
                }
            }

            // ADD AGE CONTEXT WARNING
            let ageContext = '';
            if (inputs.age === 'child') {
                if (diagnosis.includes('MELANOMA')) {
                    ageContext = 'üìå <strong>Age Context:</strong> Paziente < 20 anni. Melanoma √® RARISSIMO in questa fascia. Se pattern √® "Spitz-like", riconsiderare fortemente Spitz/Wiesner prima di diagnosi melanoma. Basato su epidemiologia (Massi & Leboit).';
                }
            } else if (inputs.age === 'elderly') {
                if (diagnosis.includes('SPITZ') || diagnosis.includes('BENIGNO')) {
                    ageContext = '‚ö†Ô∏è <strong>Age Context:</strong> Paziente > 60 anni. Spitz in questa fascia √® raro. Se lesione √® de novo su sun-damaged skin, riconsiderare melanoma anche se pattern √® "Spitz-like". TERT promoter + CDKN2A loss sono criteri duri.';
                }
            }

            // RENDER
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('morphResult').classList.add('active');

            const morphDiag = document.getElementById('morphDiagnosis');
            morphDiag.innerHTML = `
                ${diagnosis}
                <span class="badge ${badgeClass}">${redFlags.length} red | ${yellowFlags.length} yellow | ${greenFlags.length} green</span>
            `;

            document.getElementById('morphExplanations').innerHTML = `
                ${ageContext ? `<div style="background: var(--accent-soft); border: 1px solid rgba(37,99,235,0.3); border-radius: 0.6rem; padding: 0.8rem; margin-bottom: 1rem; font-size: 0.8rem; line-height: 1.5;">${ageContext}</div>` : ''}
                <ul>
                    ${greenFlags.map(f => `<li style="color: var(--ok);">‚úÖ ${f}</li>`).join('')}
                    ${yellowFlags.map(f => `<li style="color: var(--warn);">‚ö†Ô∏è ${f}</li>`).join('')}
                    ${redFlags.map(f => `<li style="color: var(--danger);">üö® ${f}</li>`).join('')}
                </ul>
            `;

            // Show Bastian tab
            document.querySelector('.tab:nth-child(2)').style.display = 'block';
        }

        function applyBastian() {
            const driver = document.getElementById('bastian_driver').value;
            const cna = document.getElementById('bastian_cna').value;

            if (!driver || !cna) {
                alert('Seleziona driver e CNA');
                return;
            }

            let diagnosis = '';
            let explanation = '';

            // CRITERIO DURO
            if (driver === 'tert_promoter' || (driver === 'cdkn2a_loss' && cna === 'complex')) {
                diagnosis = 'üö® MELANOMA SPITZOIDE (Criterio Duro)';
                explanation = 'Genotipo = MELANOMA. La morfologia √® ingannevolmente "Spitz-like".';
            } else if (['braf_v600', 'nras_q61', 'nf1_loss'].includes(driver)) {
                diagnosis = 'üö® MELANOMA';
                explanation = `${driver.toUpperCase()} = melanoma genotipo, indipendentemente da aspetto.`;
            } else if (driver === 'map3k8_fusion' && cna === 'complex') {
                diagnosis = 'üö® SPITZOIDE MALIGNO';
                explanation = 'MAP3K8 + CNA complessi = aggressivo';
            } else if (driver === 'hras_mut' && cna === 'none') {
                diagnosis = '‚úÖ SPITZ BENIGNO ZERO-RISK';
                explanation = 'HRAS-mutated + CNA calmo = Spitz classico, prognosi eccellente.';
            } else if (['alk_fusion', 'ros1_fusion', 'ret_fusion'].includes(driver) && cna === 'none') {
                diagnosis = '‚úÖ SPITZ BENIGNO CON FUSIONE';
                explanation = `${driver.toUpperCase()} + CNA calmo = low-risk nevus.`;
            } else if (cna === 'limited') {
                diagnosis = '‚ö†Ô∏è AST LOW-RISK';
                explanation = 'CNA limitati + driver Spitz-like = intermedio, follow-up consigliato.';
            } else {
                diagnosis = '‚ö†Ô∏è PROFILO ETEROGENEO';
                explanation = 'Consultare patologo esperto per interpretazione.';
            }

            document.getElementById('bastianDiagnosis').innerHTML = diagnosis;
            document.getElementById('bastianExplanations').innerHTML = `<p>${explanation}</p>`;
            document.getElementById('bastianChips').innerHTML = `
                <span class="chip">Driver: ${driver}</span>
                <span class="chip">CNA: ${cna}</span>
            `;

            document.getElementById('bastianSection').style.display = 'none';
            document.getElementById('bastianResult').style.display = 'block';
        }

        function updateBastianPreview() {
            // Could add real-time preview here
        }

        function switchTab(e, tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            e.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function resetForm() {
            document.querySelectorAll('select').forEach(s => s.value = '');
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('morphResult').classList.remove('active');
            document.getElementById('bastianSection').style.display = 'block';
            document.getElementById('bastianResult').style.display = 'none';
        }
    </script>
</body>
</html>
